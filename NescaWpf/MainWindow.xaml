<Window x:Class="NescaWpf.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="NESCA WPF — Сканер сетевых сервисов" Height="800" Width="1200" Background="#1e1e1e" Foreground="#e0e0e0"
        WindowStartupLocation="CenterScreen">
    <Window.Resources>
        <!-- Стиль для выделения особых находок в DataGrid -->
        <Style x:Key="SpecialFlagStyle" TargetType="DataGridRow">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Result.SpecialFlag}" Value="CAM">
                    <Setter Property="Background" Value="#FF4040"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding Result.Vulnerability}" Value="Дефолтный пароль">
                    <Setter Property="Background" Value="#FFFF40"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>
    <DockPanel>
        <StackPanel DockPanel.Dock="Top" Orientation="Vertical" Margin="10">
            <TextBlock Text="NESCA WPF — Многопоточный сканер сетевых сервисов" FontSize="22" FontWeight="Bold" Foreground="#88ccff" Margin="0,0,0,10"/>
            <WrapPanel Margin="0,0,0,6">
                <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                    <TextBlock Text="Диапазоны IP:"/>
                    <TextBox Width="300" Height="42" Text="{Binding ScanSettings.IpRanges, UpdateSourceTrigger=PropertyChanged}" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" TextChanged="TextBox_TextChanged" Background="#FF373737" Foreground="White"/>
                </StackPanel>
                <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                    <TextBlock Text="Порты:"/>
                    <TextBox Width="150" Text="{Binding ScanSettings.Ports, UpdateSourceTrigger=PropertyChanged}" ToolTip="например: 21,22,80,443 или диапазон 1-1024" Background="#FF373737" Foreground="White"/>
                </StackPanel>
                <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                    <TextBlock Text="Потоков:"/>
                    <TextBox Width="70" Text="{Binding ScanSettings.Threads, UpdateSourceTrigger=PropertyChanged}" ToolTip="Количество параллельных потоков"/>
                </StackPanel>
                <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                    <TextBlock Text="Таймаут (мс):"/>
                    <TextBox Width="70" Text="{Binding ScanSettings.Timeout, UpdateSourceTrigger=PropertyChanged}" ToolTip="Таймаут соединения в миллисекундах"/>
                </StackPanel>
                <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                    <TextBlock Text="Тип сканирования:"/>
                    <StackPanel Orientation="Horizontal">
                        <CheckBox Content="TCP" IsChecked="{Binding ScanSettings.EnableTcp}" Margin="0,0,10,0" Foreground="#FF7F7F7F"/>
                        <CheckBox Content="UDP" IsChecked="{Binding ScanSettings.EnableUdp}" Foreground="#FF9A9A9A"/>
                    </StackPanel>
                </StackPanel>
                <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                    <TextBlock Text="Пресеты портов:"/>
                    <ComboBox Width="150" ItemsSource="{Binding PortPresets}" SelectedItem="{Binding SelectedPreset}"/>
                </StackPanel>
                <StackPanel Orientation="Vertical" Margin="0,0,20,0">
                    <TextBlock Text="Исключить IP:"/>
                    <TextBox Width="200" Text="{Binding ScanSettings.IpExcludes, UpdateSourceTrigger=PropertyChanged}" ToolTip="Список IP или диапазонов для исключения"/>
                </StackPanel>
                <Button Content="Сохранить настройки" Command="{Binding SaveSettingsCommand}" Margin="20,25,0,0" Width="180"/>
            </WrapPanel>
            <WrapPanel Margin="0,0,0,6">
                <Button Content="Старт" Command="{Binding StartScanCommand}" Width="120" Margin="0,0,10,0" IsEnabled="{Binding CanStart}"/>
                <Button Content="Пауза" Command="{Binding PauseScanCommand}" Width="120" Margin="0,0,10,0" IsEnabled="{Binding CanPause}"/>
                <Button Content="Продолжить" Command="{Binding ResumeScanCommand}" Width="120" Margin="0,0,10,0" IsEnabled="{Binding CanResume}"/>
                <Button Content="Стоп" Command="{Binding StopScanCommand}" Width="120" Margin="0,0,10,0" IsEnabled="{Binding CanStop}"/>
                <Button Content="Очистить" Command="{Binding ClearResultsCommand}" Width="120" Margin="0,0,10,0"/>
                <Button Content="Экспорт..." Command="{Binding ExportCommand}" Width="120"/>
                <Button Content="История" Command="{Binding ShowHistoryCommand}" Width="120" Margin="0,0,10,0"/>
                <Button Content="FAQ / Справка" Command="{Binding ShowFaqCommand}" Width="120"/>
            </WrapPanel>
            <ProgressBar Height="20" Minimum="0" Maximum="{Binding TotalTasks}" Value="{Binding Progress}" Margin="0,0,0,2"/>
            <TextBlock Text="{Binding Status}" FontWeight="Bold"/>
        </StackPanel>

        <TabControl x:Name="MainTabControl" Margin="10" Background="#23232e">
            <TabItem Header="Результаты">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="120"/>
                    </Grid.RowDefinitions>
                    <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,4">
                        <TextBlock Text="Фильтр:" VerticalAlignment="Center" Foreground="#FF757272"/>
                        <TextBox Width="200" Margin="5,0,0,0" Text="{Binding FilterText, UpdateSourceTrigger=PropertyChanged}"/>
                        <ComboBox Width="120" Margin="5,0,0,0" ItemsSource="{Binding ServiceTypes}" SelectedItem="{Binding SelectedServiceType}" ToolTip="Тип сервиса"/>
                        <CheckBox Content="Только уязвимые" Margin="10,0,0,0" IsChecked="{Binding ShowOnlyVulnerable}" Foreground="#FF656565"/>
                        <CheckBox Content="Только новые" Margin="10,0,0,0" IsChecked="{Binding ShowOnlyNew}" Foreground="#FF616161"/>
                    </StackPanel>
                    <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredResults}" 
                              AutoGenerateColumns="False" IsReadOnly="True" SelectionMode="Extended"
                              RowStyle="{StaticResource SpecialFlagStyle}">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="IP" Binding="{Binding Result.Ip}"/>
                            <DataGridTextColumn Header="Порт" Binding="{Binding Result.Port}"/>
                            <DataGridTextColumn Header="Протокол" Binding="{Binding Result.Protocol}"/>
                            <DataGridTextColumn Header="Баннер" Binding="{Binding Result.Banner}"/>
                            <DataGridTextColumn Header="Сервис" Binding="{Binding Result.ServiceType}"/>
                            <DataGridTextColumn Header="Уязвимость" Binding="{Binding Result.Vulnerability}"/>
                            <DataGridTextColumn Header="Особое" Binding="{Binding Result.SpecialFlag}"/>
                            <DataGridTextColumn Header="Время" Binding="{Binding Result.Time}"/>
                        </DataGrid.Columns>
                    </DataGrid>
                    <StackPanel Grid.Row="2" Orientation="Horizontal" VerticalAlignment="Top">
                        <Button Content="Открыть в браузере" Command="{Binding OpenInBrowserCommand}" Width="180" Margin="0,4,10,0"/>
                        <Button Content="Запустить внешний скрипт" Command="{Binding RunExternalScriptCommand}" Width="180" Margin="0,4,10,0"/>
                        <TextBlock Text="Лог:" VerticalAlignment="Top" Margin="20,4,0,0" Foreground="#FF737373"/>
                        <TextBox Text="{Binding LogText}" Width="600" Height="100" Margin="5,4,0,0" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"/>
                    </StackPanel>
                </Grid>
            </TabItem>
            <TabItem Header="Статистика">
                <StackPanel>
                    <TextBlock Text="Статистика сканирования" FontWeight="Bold" FontSize="16" Margin="0,0,0,10" Foreground="DimGray"/>
                    <WebBrowser x:Name="StatsWebBrowser" Height="400"/>
                    <TextBlock Text="{Binding Statistics.Summary}" FontSize="14" Margin="0,10,0,0"/>
                </StackPanel>
            </TabItem>
            <TabItem Header="История">
                <ListBox ItemsSource="{Binding ScanHistory}">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="{Binding ScanDate}" Margin="0,0,10,0"/>
                                <TextBlock Text="{Binding Summary}" FontWeight="Bold"/>
                                <Button Content="Загрузить" Command="{Binding DataContext.LoadHistoryCommand, RelativeSource={RelativeSource AncestorType=TabItem}}" 
                                        CommandParameter="{Binding}" Margin="10,0,0,0"/>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </TabItem>
            <TabItem Header="FAQ / Справка">
                <ScrollViewer>
                    <TextBlock Text="{Binding FaqText}" TextWrapping="Wrap"/>
                </ScrollViewer>
            </TabItem>
        </TabControl>
    </DockPanel>
</Window>